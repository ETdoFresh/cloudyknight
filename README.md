# CloudyKnight - Automated Workspace Container Management

A sophisticated Docker-based development environment that automatically detects, containerizes, and manages multiple project workspaces with Traefik reverse proxy integration for seamless HTTPS access.

## 🎯 Overview

CloudyKnight provides an automated solution for managing multiple development projects in isolated Docker containers. The system monitors a workspaces directory, automatically detects project types, generates appropriate Docker configurations, and manages container lifecycles - all while providing secure HTTPS access through Traefik.

### Key Features

- **Automatic Project Detection**: Identifies Node.js, Python, PHP, Go, Ruby, and static HTML projects
- **Dynamic Container Management**: Automatically creates and manages Docker containers for each workspace
- **Traefik Integration**: Provides automatic SSL/TLS certificates and intelligent routing
- **Real-time Monitoring**: Web dashboard with live updates via WebSocket connections
- **Zero Configuration**: Projects are automatically detected and configured without manual intervention

## 🏗️ Architecture

```
etdofresh-dev.duckdns.org
         │
         ▼
    [Traefik Proxy]
         │
    ┌────┴────┬─────────┬──────────┐
    │         │         │          │
    ▼         ▼         ▼          ▼
  [www]   [monitor]  [blog]    [api]
   /         /monitor  /blog    /api
```

### Core Components

#### 1. **Traefik Reverse Proxy**
- Handles all incoming HTTPS traffic
- Provides automatic SSL certificates via Let's Encrypt
- Routes requests to appropriate containers based on URL paths

#### 2. **Monitor Service** (`/workspaces/monitor`)
The brain of the system that:
- Scans `/workspaces` directory every 30 seconds
- Detects project types based on file signatures
- Generates Docker Compose configurations
- Manages container lifecycles
- Provides web dashboard at `/monitor`
- Exposes REST API and WebSocket endpoints

#### 3. **Workspace Containers**
Each project in `/workspaces` gets:
- Its own Docker container
- Automatic routing configuration
- Appropriate runtime environment based on project type
- Read-only volume mounts for security

## 📁 Project Structure

```
/home/claude/cloudyknight/
├── README.md                     # This file
├── .claude/                      # Claude Code configuration
│   └── settings.json
├── workspaces/
│   ├── monitor/                  # Monitor service
│   │   ├── src/
│   │   │   ├── index.js         # Entry point
│   │   │   ├── monitor.js       # Core monitoring logic
│   │   │   ├── project-detector.js  # Project type detection
│   │   │   ├── compose-generator.js # Docker Compose generation
│   │   │   ├── docker-manager.js    # Container management
│   │   │   └── web-server.js    # Dashboard and API
│   │   ├── public/
│   │   │   └── index.html       # Web dashboard UI
│   │   ├── package.json
│   │   └── docker-compose.yml   # Auto-generated
│   └── www/                      # Static file server
│       ├── public/               # Static files
│       │   └── index.html
│       ├── package.json
│       └── docker-compose.yml   # Auto-generated by monitor
```

## 🚀 Getting Started

### Prerequisites

- Docker and Docker Compose installed
- Traefik network configured (`traefik-network`)
- Domain pointing to your server (e.g., etdofresh-dev.duckdns.org)

### Installation

1. **Clone the repository:**
   ```bash
   git clone <repository-url>
   cd cloudyknight
   ```

2. **Install monitor dependencies:**
   ```bash
   cd workspaces/monitor
   npm install
   ```

3. **Start the monitor service:**
   ```bash
   docker-compose up -d
   ```

The monitor will automatically:
- Detect all projects in `/workspaces`
- Generate Docker Compose configurations
- Start containers for each project
- Configure Traefik routing

### Adding New Projects

Simply create a new directory in `/workspaces` with your project files:

```bash
mkdir workspaces/myapp
cd workspaces/myapp
# Add your project files (package.json, index.js, etc.)
```

The monitor will automatically:
1. Detect the new project
2. Identify its type (Node.js, Python, etc.)
3. Generate appropriate Docker configuration
4. Start the container
5. Configure routing at `https://yourdomain.com/myapp`

## 🔧 How It Works

### Project Detection

The monitor identifies project types by checking for specific files:

| Project Type | Detection Files | Container Image | Default Command |
|-------------|----------------|-----------------|-----------------|
| Node.js | package.json | node:20-alpine | npm start |
| Python | requirements.txt, app.py | python:3.11-slim | python app.py |
| PHP | index.php, composer.json | php:8.2-apache | apache2-foreground |
| Go | go.mod, main.go | golang:1.21-alpine | go run main.go |
| Ruby | Gemfile | ruby:3.2-slim | bundle exec rails server |
| Static HTML | index.html | node:20-alpine | http-server |

### Routing Rules

The system uses intelligent routing to separate concerns:

- **Root domain (`/`)**: Served by the `www` workspace
- **Files with extensions (`/file.txt`)**: Served by the `www` workspace
- **Paths without extensions (`/blog`, `/api`)**: Reserved for workspace projects

Example routing:
- `https://domain.com/` → www workspace
- `https://domain.com/styles.css` → www workspace
- `https://domain.com/blog` → blog workspace container
- `https://domain.com/api/users` → api workspace container
- `https://domain.com/monitor` → monitor dashboard

### Container Management

Each workspace container is configured with:
- **Automatic restart**: `unless-stopped` policy
- **Read-only mounts**: Source code mounted as read-only for security
- **Network isolation**: Containers only accessible through Traefik
- **Resource limits**: Can be configured per project type
- **Health checks**: Automatic container health monitoring

### Monitoring Dashboard

Access the web dashboard at `https://yourdomain.com/monitor` to:
- View all detected projects and their status
- Start/stop/restart containers
- View container logs
- Monitor system health
- See real-time updates via WebSocket

## 🔒 Security Considerations

1. **Read-only Mounts**: Project files are mounted read-only to prevent container modifications
2. **Network Isolation**: Containers are only accessible through Traefik
3. **HTTPS Only**: All traffic is encrypted with automatic SSL certificates
4. **No Direct Port Exposure**: Containers don't expose ports directly to the host

## 📝 Configuration

### Monitor Configuration

Edit `workspaces/monitor/src/index.js` to customize:
- Scan interval (default: 30 seconds)
- Domain name
- Network name
- Port allocations

### Project-Specific Configuration

Create a `workspace.json` in any project directory for custom settings:

```json
{
  "type": "node",
  "port": 3000,
  "command": "npm run dev",
  "environment": {
    "NODE_ENV": "development"
  }
}
```

## 🐛 Troubleshooting

### View Monitor Logs
```bash
docker logs workspace-monitor
```

### Check Container Status
```bash
docker ps -a | grep workspace-
```

### Restart Monitor
```bash
docker restart workspace-monitor
```

### Manual Workspace Rebuild
```bash
cd workspaces/monitor
docker-compose down
docker-compose up -d --build
```

## 📊 API Endpoints

The monitor exposes these REST endpoints:

- `GET /api/status` - System status and configuration
- `GET /api/projects` - List all detected projects
- `GET /api/logs` - Recent monitor logs
- `GET /api/project/:name/logs` - Specific project container logs

WebSocket events:
- `status` - Periodic status updates
- `project:restart` - Restart a specific project
- `project:restarted` - Confirmation of restart

## 🔄 Development Workflow

1. **Local Development**: Work on your code locally
2. **Push to Workspace**: Copy/sync files to `/workspaces/yourproject`
3. **Automatic Detection**: Monitor detects changes and rebuilds if needed
4. **Access via HTTPS**: Test at `https://yourdomain.com/yourproject`

## 📚 Advanced Features

### Custom Dockerfiles

If a project includes a `Dockerfile`, the monitor will use it instead of the default configuration.

### Environment Variables

Projects can include `.env` files for environment-specific configuration (ensure they're not committed to git).

### Multi-Stage Deployments

The monitor can be extended to support different environments (dev, staging, prod) with different configurations.

## 🤝 Contributing

Contributions are welcome! Key areas for enhancement:
- Additional language/framework detection
- Performance monitoring integration
- Database container management
- Development vs. production modes
- Container resource management

## 📄 License

[Specify your license here]

## 🙏 Acknowledgments

Built with:
- Docker & Docker Compose
- Traefik Proxy
- Node.js & Express
- Socket.io
- Chokidar file watcher

---

**Created by CloudyKnight** | Powered by automated container orchestration